## 自定义路由监听Widget，实现类似iOS中的willAppear和disAppear

我们知道flutter框架中有`StatefulWidget`的存在，而它对应的`State`有自己的一套生命周期。具体可查阅[State生命周期](https://book.flutterchina.club/chapter2/flutter_widget_intro.html#_2-2-6-state)。它并不能完全满足类似iOS中**UIViewController**生命周期的需求。庆幸
的是`RouteObserver`这个类可以帮我们实现。

`RouteObserver`详解本篇文章就不说了，网上资料一大把。但是`RouteObserver`使用起来比较繁琐，每一个需要监听路由变化的`Widget`都需要去实现接口`RouteAware`。并重写`didChangeDependencies`方法(在其中添加订阅消息的代码)和`dispose`方法（在其中取消订阅）。

所以我将这个功能封装成了一个**Widget**：`CWRouteListenWidget`，使用起来非常方便，只需在`build`方法中，将你需要监听的**Widget**作为`CWRouteListenWidget`的子Widget即可。

示例代码如下：

* 其中`appearHandler`类似iOS中的`viewWillAppear||viewDidAppear `
* 其中`disappearHandler`类似iOS中的`viewWillDisappear||viewDidDisappear `

```dart
class TempPage extends StatelessWidget {

  const TempPage({Key? key}) : super(key: key);

  void _appear(CWRouteChangeType type) {
    switch (type) {
      case CWRouteChangeType.push:
        debugPrint("从其他页面push到当前页面");
        break;
      case CWRouteChangeType.pop:
        debugPrint("从其他页面返回到当前页面");
        break;
    }
  }

  void _disappear(CWRouteChangeType type) {
    switch (type) {
      case CWRouteChangeType.push:
        debugPrint("从当前页面push到其他页面");
        break;
      case CWRouteChangeType.pop:
        debugPrint("从当前页面返回到其他页面");
        break;
    }
  }

  @override
  Widget build(BuildContext context) {
    return CWRouteListenWidget(
      appearHandler: _appear,
      disappearHandler: _disappear,
      child: Scaffold(
        appBar: AppBar(
          title: const Text("test"),
        ),
        body: const Center(
          child: Text("content"),
        ),
      ),
    );
  }
}
```



`CWRouteListenWidget`源码如下：

```dart
import 'package:flutter/material.dart';

// 路由操作枚举
enum CWRouteChangeType {
  push,
  pop
}

// 路由监听widget
class CWRouteListenWidget extends StatefulWidget {

  static RouteObserver<PageRoute> routeObserver = RouteObserver<PageRoute>();

  final Widget child;

  // 当前页面展示时的回调
  final Function(CWRouteChangeType)? appearHandler;

  // 当前页面消失时的回调
  final Function(CWRouteChangeType)? disappearHandler;

  // 构造方法
  const CWRouteListenWidget({Key? key, required this.child, this.appearHandler, this.disappearHandler}) : super(key: key);

  @override
  _CWRouteListenWidgetState createState() => _CWRouteListenWidgetState();
}

class _CWRouteListenWidgetState extends State<CWRouteListenWidget> with RouteAware {

  @override
  void didChangeDependencies() {
    ModalRoute? route = ModalRoute.of(context);
    if (route != null) {
      CWRouteListenWidget.routeObserver.unsubscribe(this);
      // 注册监听
      CWRouteListenWidget.routeObserver.subscribe(this, route as PageRoute);
    }
    super.didChangeDependencies();
  }

  @override
  void dispose() {
    // 移除监听
    CWRouteListenWidget.routeObserver.unsubscribe(this);
    super.dispose();
  }

  @override
  void didPush() {
    if (widget.appearHandler != null) {
      widget.appearHandler!(CWRouteChangeType.push);
    }
    super.didPush();
  }

  @override
  void didPop() {
    if (widget.disappearHandler != null) {
      widget.disappearHandler!(CWRouteChangeType.pop);
    }
    super.didPop();
  }

  @override
  void didPushNext() {
    if (widget.disappearHandler != null) {
      widget.disappearHandler!(CWRouteChangeType.push);
    }
    super.didPushNext();
  }

  @override
  void didPopNext() {
    if (widget.appearHandler != null) {
      widget.appearHandler!(CWRouteChangeType.pop);
    }
    super.didPopNext();
  }

  @override
  Widget build(BuildContext context) {
    return widget.child;
  }
}

```

