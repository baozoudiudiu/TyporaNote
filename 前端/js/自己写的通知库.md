```javascript
// 记录通知的对象
let manager = {}

// manager中的数组是否正在遍历中
let isForEach = false

// 等待移除通知的队列
let deleteArr = []

// 自增id
let notify_id = -1

/**
 * 添加移除通知数据
 * @param {string} name 通知名
 * @param {number} index 对应的标识，详见 add 函数
 */
function addDeleteNotify(name, index) {
  if (!manager[name]) {return}
  deleteArr.push({name: name, index: index})
}

/**
 * 移除通知
 * @param {object} obj {name: '通知名', index: '对应标识'}
 */
function remove(obj) {
  let notify = manager[obj.name]
  if (!notify) {
    return;
  }
  let keyStr = `${obj.index}`
  if (notify[keyStr]) {
    delete notify[keyStr]
  }
  manager[obj.name] = notify
}

/**
   * 添加通知监听
   * @param {string} name 通知名
   * @param {function} callback 通知回调
   * @return {number} 通知唯一标识, 移除通知时会用到
   */
function add(name, callback) {
  if (!callback) {
    return -1
  }
  let notify = manager[name] || {}
  notify_id += 1
  notify[`${notify_id}`] = callback
  manager[name] = notify
  return notify_id
}

/**
 * 初始化方法，其实就是给自己添加一个删除通知的监听
 */
function init() {
  add('cw_notify_delete', () => {
    deleteArr.forEach(obj => {
      remove(obj)
    })
    deleteArr = []
  })
}

module.exports = {
  
  /**
   * 添加通知监听
   * @param {string} name 通知名
   * @param {function} callback 通知回调
   * @return {number} 通知唯一标识, 移除通知时会用到
   */
  addNotify: function(name, callback) {
    if (!manager['cw_notify_delete']) {
      // 没有初始化过，初始化一下
      init()
    }
    return add(name, callback)
  },

  /**
   * 移除通知监听
   * @param {string} name 通知名
   * @param {number} index 通知唯一标识，调用addNotify函数时返回的
   */
  removeNotify: function(name, index) {
    if (isForEach) {
      // 正在遍历，添加到移除等待队列中
      addDeleteNotify(name, index)
    }else {
      // 未遍历，直接移除
      remove({name: name, index: index})
    }
  },

  /**
   * 触发通知
   * @param {string} name 通知名
   * @param {any} data 通知时携带的数据
   */
  postNotify: function(name, data={}) {
    let notify = manager[name]
    if (!notify) {return;}
    isForEach = true
    let func = '', key = ''
    let keys = Object.keys(notify)
    for (let idx in keys) {
      key = keys[idx]; func = notify[key]
      if (Object.prototype.toString.call(func) == '[object Function]') {
        func(data)
      }
    }
    isForEach = false
    if (name != 'cw_notify_delete') {
      this.postNotify('cw_notify_delete')
    }
  }
}
```

